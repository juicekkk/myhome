<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jsk.mylogue.main.Dao.boardDao">

    <select id="getListCnt" resultType="Integer" parameterType="com.jsk.mylogue.main.vo.boardVo">
        SELECT COUNT(1) AS cnt
          FROM TB_BOARD b
             , TB_MEMBER m
             <if test='like != "" and like != null and like == "Y"'>
                , TB_LIKE l
             </if>
             <if test='scrap != "" and scrap != null and scrap == "Y"'>
                , TB_SCRAP s
             </if>
         WHERE b.del = 'N'
            <if test="categoryNum != '' and categoryNum != null">
                AND b.categoryNum = #{categoryNum}
            </if>
           AND b.mbrNum = m.mbrNum
           <if test="mbrNum != '' and mbrNum != null">
           AND b.mbrNum = #{mbrNum}
           </if>
            <choose>
                <when test='searchType != null and searchType eq "1"'>
                    AND b.title LIKE CONCAT('%', #{searchText},'%')
                </when>
                <when test='searchType != null and searchType eq "2"'>
                    AND (b.title LIKE CONCAT('%', #{searchText},'%') OR b.contents LIKE CONCAT('%', #{searchText},'%'))
                </when>
                <when test='searchType != null and searchType eq "3"'>
                    AND m.nickname LIKE CONCAT('%', #{searchText},'%')
                </when>
            </choose>
            <if test='share != "" and share != null and share == "Y"'>
                AND b.share = 'Y'
            </if>
            <if test='like != "" and like != null and like == "Y"'>
                AND b.mbrNum = l.mbrNum
                AND b.regNum = l.regNum
            </if>
            <if test='scrap != "" and scrap != null and scrap == "Y"'>
                AND b.mbrNum = s.mbrNum
                AND b.regNum = l.regNum
            </if>
    </select>

    <select id="getList" parameterType="com.jsk.mylogue.main.vo.boardVo" resultType="com.jsk.mylogue.main.vo.boardVo">
        SELECT b.regNum
             , b.thumbNail
             , b.title
             , b.subTitle
             , b.hit
             , b.regDate
             , m.nickName
             , c.categoryName
             , (SELECT COUNT(*) FROM TB_LIKE l where b.regNum = l.regNum) AS likeCnt
             <if test="mbrNum != '' and mbrNum != null">
             , IF((SELECT COUNT(*) FROM TB_LIKE l WHERE  b.regNum = l.regNum and l.mbrNum = #{mbrNum}) = '1', 'Y', 'N') AS likeYn
             </if>
          FROM TB_BOARD b
             , TB_MEMBER m
             , TB_CATEGORY c
             <if test='like != "" and like != null and like == "Y"'>
                 , TB_LIKE l
             </if>
             <if test='scrap != "" and scrap != null and scrap == "Y"'>
                 , TB_SCRAP s
             </if>
        WHERE b.del = 'N'
            <if test="categoryNum != '' and categoryNum != null">
                AND b.categoryNum = #{categoryNum}
            </if>
           AND b.mbrNum = m.mbrNum
           <if test="mbrNum != '' and mbrNum != null">
           AND b.mbrNum = #{mbrNum}
           </if>
           AND b.categoryNum = c.categoryNum
           <choose>
                <when test='searchType != null and searchType eq "1"'>
                    AND b.title LIKE CONCAT('%', #{searchText},'%')
                </when>
                <when test='searchType != null and searchType eq "2"'>
                    AND (b.title LIKE CONCAT('%', #{searchText},'%') OR b.contents LIKE CONCAT('%', #{searchText},'%'))
                </when>
                <when test='searchType != null and searchType eq "3"'>
                    AND m.nickname LIKE CONCAT('%', #{searchText},'%')
                </when>
           </choose>

            <if test='share != "" and share != null and share == "Y"'>
            AND b.share = 'Y'
            </if>
            <if test='like != "" and like != null and like == "Y"'>
                AND b.mbrNum = l.mbrNum
                AND b.regNum = l.regNum
            </if>
            <if test='scrap != "" and scrap != null and scrap == "Y"'>
                AND b.mbrNum = s.mbrNum
                AND b.regNum = l.regNum
            </if>
            <if test='share != "Y"'>
            ORDER BY b.regDate DESC
            </if>
            LIMIT #{pageStart}, #{pageCnt}
    </select>
    
    <update id="boardDel">
        UPDATE TB_BOARD SET del = 'Y' WHERE regNum = #{regNum}
    </update>

    <insert id="boardReg" parameterType="com.jsk.mylogue.main.vo.boardVo">
        INSERT INTO TB_BOARD ( mbrNum
             , categoryNum
             , thumbNail
             , title
             , subTitle
             , contents
             , hit
             , share
             , del
             , regDate
             , modDate )
        VALUES( #{mbrNum}
             , #{categoryNum}
             , #{thumbNail}
             , #{title}
             , #{subTitle}
             , #{contents}
             , 0
             , #{share}
             , 'N'
             , NOW()
             , null )
    </insert>

    <update id="boardMod">
        UPDATE TB_BOARD
           SET categoryNum = #{categoryNum}
             , thumbNail = #{thumbNail}
             , title = #{title}
             , subTitle = #{subTitle}
             , contents = #{contents}
             , share = #{share}
         WHERE regNum = #{regNum}
    </update>

    <select id="categoryNum" resultType="String" parameterType="String">
        SELECT categoryNum FROM TB_CATEGORY WHERE categoryName = UPPER(#{categoryCode})
    </select>

    <select id="likeCnt" resultType="Integer" parameterType="com.jsk.mylogue.main.vo.boardVo">
        SELECT COUNT(*) AS CNT FROM TB_LIKE WHERE mbrNum = #{mbrNum} AND regNum = #{regNum}
    </select>

    <select id="scrapCnt" resultType="Integer" parameterType="com.jsk.mylogue.main.vo.boardVo">
        SELECT COUNT(*) AS CNT FROM TB_SCRAP WHERE mbrNum = #{mbrNum} AND regNum = #{regNum}
    </select>

    <insert id="likeReg" parameterType="com.jsk.mylogue.main.vo.boardVo">
        INSERT INTO TB_LIKE ( mbrNum, regNum )
        VALUES( #{mbrNum}, #{regNum})
    </insert>

    <delete id="likeDel" parameterType="com.jsk.mylogue.main.vo.boardVo">
        DELETE FROM TB_LIKE WHERE mbrNum = #{mbrNum} AND regNum = #{regNum}
    </delete>

    <insert id="scrapReg" parameterType="com.jsk.mylogue.main.vo.boardVo">
        INSERT INTO TB_SCRAP ( mbrNum, regNum )
        VALUES( #{mbrNum}, #{regNum})
    </insert>

    <delete id="scrapDel" parameterType="com.jsk.mylogue.main.vo.boardVo">
        DELETE FROM TB_SCRAP WHERE mbrNum = #{mbrNum} AND regNum = #{regNum}
    </delete>


</mapper>