<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jsk.mylogue.main.Dao.boardDao">

    <select id="getListCnt" resultType="Integer" parameterType="com.jsk.mylogue.main.vo.boardVo">
        SELECT COUNT(1) AS cnt
          FROM TB_BOARD b
             , TB_MEMBER m
         WHERE categoryNum = #{categoryNum}
           AND b.del = 'N'
           AND b.mbrNum = m.mbrNum
           <if test="mbrNum != '' and mbrNum != null">
           AND b.mbrNum = #{mbrNum}
           </if>
            <choose>
                <when test='searchType != null and searchType eq "1"'>
                    AND b.title LIKE CONCAT('%', #{searchText},'%')
                </when>
                <when test='searchType != null and searchType eq "2"'>
                    AND (b.title LIKE CONCAT('%', #{searchText},'%') OR b.contents LIKE CONCAT('%', #{searchText},'%'))
                </when>
                <when test='searchType != null and searchType eq "3"'>
                    AND m.nickname LIKE CONCAT('%', #{searchText},'%')
                </when>
            </choose>
            <if test='share != "" and share != null and share == "Y"'>
                AND b.share = 'Y'
            </if>
    </select>

    <select id="getList" parameterType="com.jsk.mylogue.main.vo.boardVo" resultType="com.jsk.mylogue.main.vo.boardVo">
        SELECT b.regNum
             , b.thumbNail
             , b.title
             , b.subTitle
             , b.hit
             , b.regDate
             , m.nickName
             , c.categoryName
          FROM TB_BOARD b
             , TB_MEMBER m
             , TB_CATEGORY c
         WHERE c.categoryNum = #{categoryNum}
           AND b.mbrNum = m.mbrNum
           <if test="mbrNum != '' and mbrNum != null">
           AND b.mbrNum = #{mbrNum}
           </if>
           AND b.categoryNum = c.categoryNum
           AND b.del = 'N'
           <choose>
                <when test='searchType != null and searchType eq "1"'>
                    AND b.title LIKE CONCAT('%', #{searchText},'%')
                </when>
                <when test='searchType != null and searchType eq "2"'>
                    AND (b.title LIKE CONCAT('%', #{searchText},'%') OR b.contents LIKE CONCAT('%', #{searchText},'%'))
                </when>
                <when test='searchType != null and searchType eq "3"'>
                    AND m.nickname LIKE CONCAT('%', #{searchText},'%')
                </when>
           </choose>

            <if test='share != "" and share != null and share == "Y"'>
            AND b.share = 'Y'
            </if>
            <if test='share != "Y"'>
            ORDER BY b.regDate DESC
            </if>

            LIMIT #{pageStart}, #{pageCnt}
    </select>
    
    <update id="boardDel">
        UPDATE TB_BOARD SET del = 'Y' WHERE regNum = #{regNum}
    </update>

    <insert id="boardReg" parameterType="com.jsk.mylogue.main.vo.boardVo">
        INSERT INTO TB_BOARD ( mbrNum
             , categoryNum
             , thumbNail
             , title
             , subTitle
             , contents
             , hit
             , share
             , del
             , regDate
             , modDate )
        VALUES( #{mbrNum}
             , #{categoryNum}
             , #{thumbNail}
             , #{title}
             , #{subTitle}
             , #{contents}
             , 0
             , #{share}
             , 'N'
             , NOW()
             , null )
    </insert>

    <update id="boardMod">
        UPDATE TB_BOARD
           SET categoryNum = #{categoryNum}
             , thumbNail = #{thumbNail}
             , title = #{title}
             , subTitle = #{subTitle}
             , contents = #{contents}
             , share = #{share}
         WHERE regNum = #{regNum}
    </update>

    <select id="categoryNum" resultType="String" parameterType="String">
        SELECT categoryNum FROM TB_CATEGORY WHERE categoryName = UPPER(#{categoryCode})
    </select>

</mapper>